<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å³æ™‚é›™å‘å£è­¯ (V2)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #121212;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* ä¸ŠåŠéƒ¨ï¼šé¡¯ç¤ºå€ */
        .display-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        /* å°è©±æ°£æ³¡æ¨£å¼ */
        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 1.1rem;
            line-height: 1.4;
            animation: fadeIn 0.3s ease;
        }

        /* ç”¨æˆ¶èªªçš„è©± (åŸæ–‡) */
        .msg-original {
            align-self: flex-end;
            background-color: #2c2c2c;
            color: #ccc;
            border-bottom-right-radius: 4px;
            font-size: 0.9rem;
        }

        /* ç¿»è­¯çµæœ (è­¯æ–‡) */
        .msg-translated {
            align-self: flex-start;
            background-color: #007AFF;
            color: white;
            border-bottom-left-radius: 4px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,122,255,0.3);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ä¸‹åŠéƒ¨ï¼šæ§åˆ¶å€ */
        .controls-area {
            background-color: #1e1e1e;
            padding: 20px;
            padding-bottom: 40px; /* é¿é–‹æ‰‹æ©Ÿåº•éƒ¨æ©«æ¢ */
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
        }

        /* éº¥å…‹é¢¨æŒ‰éˆ• */
        .mic-btn {
            width: 45%;
            height: 70px;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .mic-btn span {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .btn-zh {
            background: linear-gradient(145deg, #ff9500, #ff5e00);
            box-shadow: 0 4px 15px rgba(255, 94, 0, 0.3);
        }

        .btn-en {
            background: linear-gradient(145deg, #00c6ff, #0072ff);
            box-shadow: 0 4px 15px rgba(0, 114, 255, 0.3);
        }

        /* éŒ„éŸ³ä¸­çš„å‹•ç•«ç‹€æ…‹ */
        .mic-btn.active {
            transform: scale(0.95);
            filter: brightness(1.2);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        
        .mic-btn.active::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            border: 2px solid white;
            border-radius: 15px;
            animation: borderPulse 1s infinite;
        }

        @keyframes borderPulse {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.1); }
        }

        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.8);
            color: #aaa;
            text-align: center;
            padding: 5px;
            font-size: 0.8rem;
            z-index: 100;
            display: none;
        }

        /* æ¸…é™¤æŒ‰éˆ• */
        .clear-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #aaa;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            z-index: 99;
        }
    </style>
</head>
<body>

<div class="status-bar" id="status-text">å°±ç·’</div>
<button class="clear-btn" onclick="clearChat()">æ¸…é™¤ç´€éŒ„</button>

<div class="display-area" id="chat-container">
    <div class="message msg-translated" style="background-color: #333;">
        æ­¡è¿ä½¿ç”¨é›™å‘å£è­¯ã€‚è«‹é•·æŒ‰ä¸‹æ–¹æŒ‰éˆ•é–‹å§‹å°è©±ã€‚
    </div>
</div>

<div class="controls-area">
    <button class="mic-btn btn-zh" id="btn-zh" onmousedown="startListening('zh-TW')" onmouseup="stopListening()" ontouchstart="startListening('zh-TW')" ontouchend="stopListening()">
        <span>ğŸ‡¹ğŸ‡¼</span>
        èªªä¸­æ–‡
    </button>

    <button class="mic-btn btn-en" id="btn-en" onmousedown="startListening('en-US')" onmouseup="stopListening()" ontouchstart="startListening('en-US')" ontouchend="stopListening()">
        <span>ğŸ‡ºğŸ‡¸</span>
        Speak EN
    </button>
</div>

<script>
    // --- è¨­å®šè®Šæ•¸ ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isRecording = false;
    let currentSourceLang = 'zh-TW';
    let currentTargetLang = 'en-US';
    let finalTranscript = ''; // å„²å­˜æœ€çµ‚çµæœ
    
    // UI å…ƒç´ 
    const chatContainer = document.getElementById('chat-container');
    const statusText = document.getElementById('status-text');
    const btnZh = document.getElementById('btn-zh');
    const btnEn = document.getElementById('btn-en');

    // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
    if (!SpeechRecognition) {
        alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ä½¿ç”¨ Chrome æˆ– Safariã€‚");
    } else {
        recognition = new SpeechRecognition();
        recognition.continuous = true; // è¨­ç‚º true å¯¦ç¾é€£çºŒè¾¨è­˜
        recognition.interimResults = false; // ç°¡åŒ–è™•ç†ï¼Œåªæ‹¿æœ€çµ‚çµæœ
        
        // ç•¶æ”¶åˆ°è¾¨è­˜çµæœ
        recognition.onresult = async (event) => {
            // ç”±æ–¼ continuous=trueï¼Œresults æœƒæ˜¯ä¸€å€‹é™£åˆ—ï¼Œæˆ‘å€‘åªå–æœ€æ–°çš„
            const lastResultIndex = event.results.length - 1;
            const transcript = event.results[lastResultIndex][0].transcript.trim();
            const isFinal = event.results[lastResultIndex].isFinal;

            if (isFinal && transcript.length > 0) {
                console.log("æ”¶åˆ°èªéŸ³:", transcript);
                
                // 1. é¡¯ç¤ºåŸæ–‡
                addMessage(transcript, 'original');
                
                // 2. æš«åœè¾¨è­˜ (é¿å…è½åˆ° TTS çš„è²éŸ³)
                recognition.stop(); 
                
                // 3. ç¿»è­¯ä¸¦æœ—è®€
                await translateAndSpeak(transcript);
            }
        };

        recognition.onerror = (event) => {
            console.error("è¾¨è­˜éŒ¯èª¤", event.error);
            if (event.error !== 'no-speech') {
                statusText.style.display = 'block';
                statusText.innerText = "éŒ¯èª¤: " + event.error;
            }
        };
        
        recognition.onend = () => {
            // å¦‚æœç”¨æˆ¶é‚„æŒ‰è‘—æŒ‰éˆ•ï¼Œæˆ–æ˜¯è™•æ–¼ã€Œè‡ªå‹•é‡å•Ÿã€ç‹€æ…‹ï¼Œé€™è£¡å¯ä»¥åšé‚è¼¯
            // ä½†ç‚ºäº†é«”é©—æœ€å¥½ï¼Œæˆ‘å€‘æ¡ç”¨ã€ŒæŒ‰ä½èªªè©±ã€æˆ–ã€Œé»æ“Šåˆ‡æ›ã€çš„æ··åˆé‚è¼¯
            // ç›®å‰æ¡ç”¨ï¼šæŒ‰ä½æœŸé–“ä¸€ç›´è½ï¼Œæ–·å¥å¾Œæš«åœå»ç¿»è­¯ï¼Œç¿»è­¯å®Œè¦æ‰‹å‹•å†æŒ‰ï¼ˆé˜²æ­¢ç„¡é™è¿´åœˆï¼‰
            // ä¿®æ­£ï¼šç”¨æˆ¶å¸Œæœ›ã€Œé•·æ™‚é–“ç¿»è­¯ã€ï¼Œæ‰€ä»¥ç¿»è­¯å®Œæ‡‰è©²è¦è‡ªå‹•é‡å•Ÿå—ï¼Ÿ
            // åœ¨æ‰‹æ©Ÿç¶²é ä¸Šï¼Œè‡ªå‹•é‡å•Ÿéº¥å…‹é¢¨å¸¸å¸¸æœƒè¢«æ“‹ï¼Œæ‰€ä»¥ã€ŒæŒ‰ä½èªªè©± (Push to Talk)ã€æ˜¯æœ€ç©©çš„ã€‚
            
            isRecording = false;
            updateBtnStyle(false);
        };
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ ---

    // é–‹å§‹è†è½ (æŒ‰ä¸‹æŒ‰éˆ•)
    function startListening(lang) {
        if (isRecording) return;
        
        // è¨­å®šèªè¨€æ–¹å‘
        if (lang === 'zh-TW') {
            currentSourceLang = 'zh-TW';
            currentTargetLang = 'en-US';
            updateBtnStyle(true, 'zh');
        } else {
            currentSourceLang = 'en-US';
            currentTargetLang = 'zh-TW';
            updateBtnStyle(true, 'en');
        }

        try {
            recognition.lang = currentSourceLang;
            recognition.start();
            isRecording = true;
            statusText.innerText = "è†è½ä¸­...";
            statusText.style.display = 'block';
        } catch (e) {
            console.error("ç„¡æ³•å•Ÿå‹•:", e);
        }
    }

    // åœæ­¢è†è½ (æ”¾é–‹æŒ‰éˆ•)
    function stopListening() {
        if (isRecording) {
            recognition.stop();
            // æ³¨æ„ï¼šstop å¾Œä¸æœƒé¦¬ä¸Š onendï¼Œè¦ç­‰è™•ç†å®Œ
        }
    }

    // æ›´æ–°æŒ‰éˆ•æ¨£å¼
    function updateBtnStyle(isActive, type) {
        btnZh.classList.remove('active');
        btnEn.classList.remove('active');
        
        if (isActive) {
            if (type === 'zh') btnZh.classList.add('active');
            if (type === 'en') btnEn.classList.add('active');
        } else {
            statusText.style.display = 'none';
        }
    }

    // ç¿»è­¯èˆ‡æœ—è®€
    async function translateAndSpeak(text) {
        // é¡¯ç¤ºã€Œç¿»è­¯ä¸­...ã€çš„ä½”ä½ç¬¦
        const loadingId = addMessage("...", 'translated');
        
        try {
            const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${currentSourceLang}|${currentTargetLang}`;
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.responseData) {
                const translatedText = data.responseData.translatedText;
                
                // æ›´æ–° UI
                document.getElementById(loadingId).innerText = translatedText;
                
                // æœ—è®€
                await speak(translatedText, currentTargetLang);
                
            } else {
                document.getElementById(loadingId).innerText = "ç¿»è­¯éŒ¯èª¤";
            }
        } catch (e) {
            document.getElementById(loadingId).innerText = "é€£ç·šå¤±æ•—";
        }
    }

    // æœ—è®€åŠŸèƒ½ (Promise å°è£ï¼Œç¢ºä¿å”¸å®Œæ‰åšä¸‹ä¸€æ­¥)
    function speak(text, lang) {
        return new Promise((resolve) => {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            
            utterance.onend = () => {
                resolve();
            };
            
            // éŒ¯èª¤è™•ç† (ä¾‹å¦‚ iOS æœ‰æ™‚ä¸è§¸ç™¼ onend)
            utterance.onerror = () => {
                resolve();
            };

            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        });
    }

    // è¼”åŠ©ï¼šæ–°å¢è¨Šæ¯åˆ°ç•«é¢
    function addMessage(text, type) {
        const div = document.createElement('div');
        const id = 'msg-' + Date.now();
        div.id = id;
        div.className = `message msg-${type}`;
        div.innerText = text;
        chatContainer.appendChild(div);
        
        // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return id;
    }
    
    function clearChat() {
        chatContainer.innerHTML = '';
    }
</script>

</body>
</html>

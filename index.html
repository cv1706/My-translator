<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å³æ™‚å£è­¯æ©Ÿ Demo</title>
<style>
body {
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
background-color: #1a1a1a;
color: #ffffff;
display: flex;
flex-direction: column;
align-items: center;
height: 100vh;
margin: 0;
overflow: hidden;
}

header {
width: 100%;
padding: 20px;
text-align: center;
background-color: #2d2d2d;
font-size: 1.2rem;
font-weight: bold;
box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.container {
flex: 1;
width: 90%;
max-width: 600px;
display: flex;
flex-direction: column;
justify-content: center;
gap: 20px;
padding: 20px 0;
}

.box {
background-color: #333;
border-radius: 15px;
padding: 20px;
min-height: 120px;
display: flex;
flex-direction: column;
justify-content: center;
box-shadow: 0 4px 6px rgba(0,0,0,0.2);
}

.label {
font-size: 0.8rem;
color: #aaa;
margin-bottom: 5px;
}

.text-content {
font-size: 1.2rem;
line-height: 1.5;
}

.controls {
display: flex;
justify-content: space-between;
align-items: center;
width: 90%;
max-width: 600px;
padding-bottom: 40px;
}

.mode-switch {
background: #444;
color: white;
border: none;
padding: 10px 20px;
border-radius: 20px;
font-size: 0.9rem;
}

#mic-btn {
width: 80px;
height: 80px;
border-radius: 50%;
border: none;
background-color: #007AFF;
color: white;
font-size: 30px;
box-shadow: 0 4px 15px rgba(0,122,255,0.4);
transition: all 0.2s;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
}

#mic-btn.listening {
background-color: #ff3b30;
animation: pulse 1.5s infinite;
}

@keyframes pulse {
0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); }
70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); }
100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); }
}

.status {
text-align: center;
height: 20px;
color: #888;
font-size: 0.9rem;
margin-bottom: 10px;
}
</style>
</head>
<body>

<header>å£è¢‹ç¿»è­¯æ©Ÿ (Web API)</header>

<div class="container">
<div class="box">
<div class="label">æˆ‘èªª (<span id="source-lang-label">ä¸­æ–‡</span>)</div>
<div class="text-content" id="original-text">è«‹é»æ“Šéº¥å…‹é¢¨é–‹å§‹èªªè©±...</div>
</div>

<div class="box" style="background-color: #3d3d3d;">
<div class="label">ç¿»è­¯ (<span id="target-lang-label">è‹±æ–‡</span>)</div>
<div class="text-content" id="translated-text">...</div>
</div>
</div>

<div class="status" id="status-text">æº–å‚™å°±ç·’</div>

<div class="controls">
<button class="mode-switch" onclick="switchLanguage()">â‡„ åˆ‡æ›èªè¨€</button>
<button id="mic-btn" onclick="toggleRecording()">ğŸ¤</button>
<button class="mode-switch" onclick="replayAudio()">ğŸ”Š é‡æ’­</button>
</div>

<script>
// è¨­å®šè®Šæ•¸
let isListening = false;
let currentLang = 'zh-TW'; // é è¨­ä¾†æºèªè¨€ï¼šä¸­æ–‡
let targetLang = 'en-US'; // é è¨­ç›®æ¨™èªè¨€ï¼šè‹±æ–‡

// æª¢æŸ¥ç€è¦½å™¨æ”¯æ´åº¦
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ä½¿ç”¨ Chrome æˆ– Safariã€‚");
}

const recognition = new SpeechRecognition();
recognition.continuous = false; // è¬›å®Œä¸€å¥å°±åœ
recognition.interimResults = false; // ä¸é¡¯ç¤ºä¸­é–“çµæœï¼Œç¢ºèªå¾Œå†é¡¯ç¤º

// UI å…ƒç´ 
const micBtn = document.getElementById('mic-btn');
const statusText = document.getElementById('status-text');
const originalTextDiv = document.getElementById('original-text');
const translatedTextDiv = document.getElementById('translated-text');
const sourceLabel = document.getElementById('source-lang-label');
const targetLabel = document.getElementById('target-lang-label');

// åˆ‡æ›ä¸­è‹±æ¨¡å¼
function switchLanguage() {
if (currentLang === 'zh-TW') {
currentLang = 'en-US';
targetLang = 'zh-TW';
sourceLabel.innerText = 'è‹±æ–‡';
targetLabel.innerText = 'ä¸­æ–‡';
} else {
currentLang = 'zh-TW';
targetLang = 'en-US';
sourceLabel.innerText = 'ä¸­æ–‡';
targetLabel.innerText = 'è‹±æ–‡';
}
statusText.innerText = `æ¨¡å¼åˆ‡æ›ï¼š${sourceLabel.innerText} -> ${targetLabel.innerText}`;
}

// éº¥å…‹é¢¨é–‹é—œ
function toggleRecording() {
if (isListening) {
recognition.stop();
} else {
recognition.lang = currentLang;
recognition.start();
}
}

// è¾¨è­˜é–‹å§‹
recognition.onstart = () => {
isListening = true;
micBtn.classList.add('listening');
statusText.innerText = "æ­£åœ¨è†è½...";
originalTextDiv.innerText = "...";
translatedTextDiv.innerText = "...";
};

// è¾¨è­˜çµæŸ
recognition.onend = () => {
isListening = false;
micBtn.classList.remove('listening');
statusText.innerText = "è™•ç†ä¸­...";
};

// æ”¶åˆ°çµæœ
recognition.onresult = async (event) => {
const transcript = event.results[0][0].transcript;
originalTextDiv.innerText = transcript;

// å‘¼å«ç¿»è­¯ API
await translateAndSpeak(transcript);
};

recognition.onerror = (event) => {
statusText.innerText = "éŒ¯èª¤: " + event.error;
isListening = false;
micBtn.classList.remove('listening');
};

// ç¿»è­¯ä¸¦æœ—è®€æ ¸å¿ƒå‡½å¼
async function translateAndSpeak(text) {
try {
statusText.innerText = "ç¿»è­¯ä¸­...";

// ä½¿ç”¨ MyMemory å…è²»ç¿»è­¯ API
// æ³¨æ„ï¼šé€™æ˜¯å…¬é–‹ APIï¼Œæœ‰å­—æ•¸é™åˆ¶èˆ‡éš±ç§é¢¨éšªï¼Œåƒ…ä¾› Demo ä½¿ç”¨
const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${currentLang}|${targetLang}`;

const response = await fetch(url);
const data = await response.json();

if (data.responseData) {
const translatedText = data.responseData.translatedText;
translatedTextDiv.innerText = translatedText;
statusText.innerText = "å®Œæˆ";

// æœ—è®€ç¿»è­¯çµæœ
speak(translatedText, targetLang);
} else {
throw new Error("API å›å‚³éŒ¯èª¤");
}
} catch (error) {
console.error(error);
statusText.innerText = "ç¿»è­¯å¤±æ•—ï¼Œè«‹é‡è©¦";
translatedTextDiv.innerText = "ç¿»è­¯æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨";
}
}

// æ–‡å­—è½‰èªéŸ³ (TTS)
function speak(text, lang) {
// åœæ­¢ç›®å‰çš„ç™¼éŸ³ï¼ˆè‹¥æœ‰çš„è©±ï¼‰
window.speechSynthesis.cancel();

const utterance = new SpeechSynthesisUtterance(text);
utterance.lang = lang;
utterance.rate = 1; // èªé€Ÿ

// è§£æ±º iOS èªéŸ³å•é¡Œ (æœ‰æ™‚å€™éœ€è¦é¸ç‰¹å®š voice)
const voices = window.speechSynthesis.getVoices();
// é€™è£¡å¯ä»¥åŠ å…¥æ›´è¤‡é›œçš„èªéŸ³é¸æ“‡é‚è¼¯ï¼Œç›®å‰å…ˆç”¨é è¨­

window.speechSynthesis.speak(utterance);
}

function replayAudio() {
const text = translatedTextDiv.innerText;
if (text && text !== "...") {
speak(text, targetLang);
}
}
</script>

</body>
</html>

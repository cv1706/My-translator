<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI åŒæ­¥å£è­¯ (V6-è€³æ©Ÿç‰ˆ)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #000000;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* è­¦å‘Šæ¨™èª */
        .warning-bar {
            background-color: #ffcc00;
            color: #000;
            font-size: 0.8rem;
            text-align: center;
            padding: 5px;
            font-weight: bold;
        }

        /* é ‚éƒ¨åŠŸèƒ½åˆ— */
        .top-bar {
            background-color: #1c1c1e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background-color: #555;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-dot.active { background-color: #30d158; box-shadow: 0 0 10px #30d158; animation: pulse 1.5s infinite; }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* å°è©±é¡¯ç¤ºå€ */
        .display-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        .message-group { animation: slideIn 0.3s ease; }
        .original-text { color: #8e8e93; font-size: 0.9rem; margin-bottom: 2px; margin-left: 12px; }
        
        .translated-card {
            background-color: #1c1c1e;
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 1.2rem;
            line-height: 1.4;
            color: #fff;
            border-left: 4px solid #333;
            word-wrap: break-word;
        }

        .border-color-A { border-left-color: #ff9f0a; }
        .border-color-B { border-left-color: #0a84ff; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* åº•éƒ¨æ§åˆ¶å€ */
        .controls-area {
            background-color: #1c1c1e;
            padding: 15px;
            padding-bottom: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            position: relative;
        }

        .lang-select {
            width: 100%;
            padding: 8px;
            background-color: #2c2c2e;
            color: #fff;
            border: 1px solid #444;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 5px;
        }

        .column { display: flex; flex-direction: column; gap: 5px; }

        .control-btn {
            height: 70px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            background-color: #2c2c2e;
        }

        .btn-active-A { background-color: #ff9f0a; color: #000; border: 2px solid white; }
        .btn-active-B { background-color: #0a84ff; color: #fff; border: 2px solid white; }
        .dimmed { opacity: 0.4; pointer-events: none; }
        
        .stop-btn {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            background-color: #ff453a;
            color: white;
            padding: 10px 30px;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 69, 58, 0.4);
            transition: transform 0.3s;
            z-index: 100;
            border: none;
        }
        .stop-btn.show { transform: translateX(-50%) scale(1); }

    </style>
</head>
<body>

<div class="warning-bar">âš ï¸ å¼·çƒˆå»ºè­°ä½©æˆ´è€³æ©Ÿä»¥é¿å…å›éŸ³</div>

<div class="top-bar">
    <div style="display:flex; align-items:center;">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text" style="font-size:0.9rem; color:#ccc;">å°±ç·’</span>
    </div>
    <button onclick="toggleTts()" id="tts-btn" style="background:none; border:1px solid #555; color:#fff; padding:4px 10px; border-radius:15px; font-size:0.8rem;">ğŸ”Š æœ—è®€é–‹</button>
</div>

<div class="display-area" id="chat-container">
    <div class="message-group">
        <div class="translated-card">
            ğŸ§ é€™æ˜¯åŒæ­¥æ¨¡å¼ã€‚<br>
            éº¥å…‹é¢¨ä¸æœƒä¸­æ–·ï¼Œè«‹ç›¡æƒ…èªªè©±ã€‚<br>
            (è«‹ä½¿ç”¨è€³æ©Ÿ)
        </div>
    </div>
</div>

<div class="controls-area">
    <button class="stop-btn" id="stop-btn" onclick="stopEverything()">â¬› åœæ­¢åŒæ­¥</button>
    
    <div class="column">
        <select class="lang-select" id="select-A" onchange="updateLabels()">
            <option value="zh-TW|ğŸ‡¹ğŸ‡¼">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡</option>
            <option value="en-US|ğŸ‡ºğŸ‡¸">ğŸ‡ºğŸ‡¸ è‹±æ–‡</option>
            <option value="ja-JP|ğŸ‡¯ğŸ‡µ">ğŸ‡¯ğŸ‡µ æ—¥æ–‡</option>
            <option value="ko-KR|ğŸ‡°ğŸ‡·">ğŸ‡°ğŸ‡· éŸ“æ–‡</option>
        </select>
        <button class="control-btn" id="btn-A" onclick="startContinuous('A')">
            <span id="icon-A" style="font-size:1.4rem;">ğŸ‡¹ğŸ‡¼</span>
            <span id="text-A">è½ä¸­æ–‡</span>
        </button>
    </div>

    <div class="column">
        <select class="lang-select" id="select-B" onchange="updateLabels()">
            <option value="en-US|ğŸ‡ºğŸ‡¸" selected>ğŸ‡ºğŸ‡¸ è‹±æ–‡</option>
            <option value="zh-TW|ğŸ‡¹ğŸ‡¼">ğŸ‡¹ğŸ‡¼ ä¸­æ–‡</option>
            <option value="ja-JP|ğŸ‡¯ğŸ‡µ">ğŸ‡¯ğŸ‡µ æ—¥æ–‡</option>
            <option value="ko-KR|ğŸ‡°ğŸ‡·">ğŸ‡°ğŸ‡· éŸ“æ–‡</option>
        </select>
        <button class="control-btn" id="btn-B" onclick="startContinuous('B')">
            <span id="icon-B" style="font-size:1.4rem;">ğŸ‡ºğŸ‡¸</span>
            <span id="text-B">è½è‹±æ–‡</span>
        </button>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒè®Šæ•¸ ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let activeSide = null; // 'A' or 'B'
    let isRunning = false; // æ˜¯å¦åœ¨é‹ä½œä¸­
    let isTtsEnabled = true;
    
    // èªéŸ³æ’­æ”¾ä½‡åˆ— (é‡è¦ï¼é¿å…åŒæ™‚è¬›è©±æ‰“æ¶)
    let ttsQueue = []; 
    let isSpeaking = false;

    // UI ç¶å®š
    const ui = {
        btnA: document.getElementById('btn-A'),
        btnB: document.getElementById('btn-B'),
        selA: document.getElementById('select-A'),
        selB: document.getElementById('select-B'),
        stopBtn: document.getElementById('stop-btn'),
        statusDot: document.getElementById('status-dot'),
        statusText: document.getElementById('status-text'),
        chat: document.getElementById('chat-container'),
        ttsBtn: document.getElementById('tts-btn')
    };

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true; // é—œéµï¼šé–‹å•Ÿé€£çºŒæ¨¡å¼
        recognition.interimResults = false; // åªå–æœ€çµ‚çµæœ

        recognition.onstart = () => {
            updateStatus('listening');
        };

        // æ”¶åˆ°è¾¨è­˜çµæœ (å› ç‚ºæ˜¯ continuousï¼Œé€™è£¡æœƒä¸€ç›´è§¸ç™¼)
        recognition.onresult = async (event) => {
            // æ‰¾å‡ºæœ€æ–°çš„ä¸€å¥ (ResultIndex æŒ‡å‘ç•¶å‰è®Šæ›´çš„é‚£ä¸€å¥)
            const resultIndex = event.resultIndex; 
            const transcript = event.results[resultIndex][0].transcript.trim();
            const isFinal = event.results[resultIndex].isFinal;

            if (isFinal && transcript.length > 0) {
                console.log("æ•æ‰åˆ°:", transcript);
                // é€™è£¡çµ•å° "ä¸" å‘¼å« recognition.stop()
                await handleTranslation(transcript);
            }
        };

        recognition.onend = () => {
            console.log("éº¥å…‹é¢¨ä¸­æ–·");
            // å¦‚æœæ‡‰è©²è¦æ˜¯åŸ·è¡Œç‹€æ…‹ï¼Œå»æ–·äº†ï¼ˆä¾‹å¦‚éœé»˜å¤ªä¹…ï¼‰ï¼Œå¼·åˆ¶é‡å•Ÿ
            if (isRunning && activeSide) {
                console.log("è‡ªå‹•é‡é€£éº¥å…‹é¢¨...");
                try { recognition.start(); } catch(e){}
            } else {
                updateStatus('idle');
            }
        };
        
        recognition.onerror = (e) => {
            console.log("Error:", e.error);
            if (e.error !== 'no-speech') {
                // é‡åˆ°éŒ¯èª¤ç¨å¾®å†·å»ä¸€ä¸‹å†é‡è©¦ï¼Œé¿å…æ­»å¾ªç’°
                if (isRunning) {
                     setTimeout(() => { if(isRunning) try{recognition.start();}catch(x){} }, 1000);
                }
            }
        };
    } else {
        alert("ä¸æ”¯æ´èªéŸ³ API");
    }

    // --- åŠŸèƒ½å‡½å¼ ---

    function startContinuous(side) {
        if (activeSide === side) {
            stopEverything(); // å†æŒ‰ä¸€æ¬¡å°±åœæ­¢
            return;
        }

        // å¦‚æœåˆ‡æ›èªè¨€æ–¹å‘ï¼Œå…ˆåœæ‰èˆŠçš„
        if (isRunning) {
            recognition.stop(); 
        }

        activeSide = side;
        isRunning = true;
        
        // æ›´æ–° UI
        ui.btnA.className = side === 'A' ? 'control-btn btn-active-A' : 'control-btn dimmed';
        ui.btnB.className = side === 'B' ? 'control-btn btn-active-B' : 'control-btn dimmed';
        ui.stopBtn.classList.add('show');

        // è¨­å®šèªè¨€
        const langVal = side === 'A' ? ui.selA.value : ui.selB.value;
        recognition.lang = langVal.split('|')[0];
        
        // å•Ÿå‹• (éœ€å»¶é²ä¸€é»é»ç¢ºä¿ stop å®Œæˆ)
        setTimeout(() => {
            try { recognition.start(); } catch(e) {}
        }, 200);
    }

    function stopEverything() {
        isRunning = false;
        activeSide = null;
        ttsQueue = []; // æ¸…ç©ºå¾…æ’­æ”¾æ¸…å–®
        window.speechSynthesis.cancel();
        
        try { recognition.stop(); } catch(e){}
        
        ui.btnA.className = 'control-btn';
        ui.btnB.className = 'control-btn';
        ui.stopBtn.classList.remove('show');
        updateStatus('idle');
    }

    async function handleTranslation(text) {
        // å–å¾—èªè¨€é…å°
        const sVal = activeSide === 'A' ? ui.selA.value : ui.selB.value;
        const tVal = activeSide === 'A' ? ui.selB.value : ui.selA.value;
        const sLang = sVal.split('|')[0];
        const tLang = tVal.split('|')[0];

        // 1. é¡¯ç¤ºåŸæ–‡
        addMessage(text, '', activeSide);

        try {
            // 2. å‘¼å«ç¿»è­¯
            const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sLang}|${tLang}`;
            const res = await fetch(url);
            const data = await res.json();
            
            if (data.responseData) {
                const transText = data.responseData.translatedText;
                // 3. é¡¯ç¤ºè­¯æ–‡
                addMessage(transText, 'translated', activeSide);
                
                // 4. åŠ å…¥æ’­æ”¾ä½‡åˆ— (ä¸ä¸­æ–·éº¥å…‹é¢¨)
                if (isTtsEnabled) {
                    addToTTSQueue(transText, tLang);
                }
            }
        } catch (e) {
            console.error(e);
        }
    }

    // --- TTS ä½‡åˆ—ç³»çµ± (é—œéµï¼šè®“è²éŸ³ä¸æ‰“æ¶) ---
    function addToTTSQueue(text, lang) {
        ttsQueue.push({ text, lang });
        processTTSQueue();
    }

    function processTTSQueue() {
        if (isSpeaking || ttsQueue.length === 0) return;

        isSpeaking = true;
        const item = ttsQueue.shift(); // å–å‡ºç¬¬ä¸€é …

        const u = new SpeechSynthesisUtterance(item.text);
        u.lang = item.lang;
        u.rate = 1.0;

        u.onend = () => {
            isSpeaking = false;
            // å”¸å®Œä¸€å¥ï¼Œé¦¬ä¸Šæª¢æŸ¥é‚„æœ‰æ²’æœ‰ä¸‹ä¸€å¥
            processTTSQueue();
        };

        u.onerror = () => {
            isSpeaking = false;
            processTTSQueue();
        };

        window.speechSynthesis.speak(u);
    }

    // --- UI è¼”åŠ© ---
    function toggleTts() {
        isTtsEnabled = !isTtsEnabled;
        ui.ttsBtn.innerText = isTtsEnabled ? 'ğŸ”Š æœ—è®€é–‹' : 'ğŸ”‡ æœ—è®€é—œ';
        if (!isTtsEnabled) window.speechSynthesis.cancel();
    }

    function updateLabels() {
        const valA = ui.selA.value.split('|');
        const valB = ui.selB.value.split('|');
        
        document.getElementById('icon-A').innerText = valA[1];
        document.getElementById('text-A').innerText = "è½" + getLangName(valA[0]);
        
        document.getElementById('icon-B').innerText = valB[1];
        document.getElementById('text-B').innerText = "è½" + getLangName(valB[0]);

        if (isRunning) stopEverything();
    }
    
    function getLangName(code) {
        if (code.includes('zh')) return 'ä¸­æ–‡';
        if (code.includes('en')) return 'è‹±æ–‡';
        if (code.includes('ja')) return 'æ—¥æ–‡';
        if (code.includes('ko')) return 'éŸ“æ–‡';
        return '';
    }

    function updateStatus(state) {
        if (state === 'listening') {
            ui.statusText.innerText = "éº¥å…‹é¢¨æŒçºŒæ”¶éŸ³ä¸­...";
            ui.statusDot.classList.add('active');
        } else {
            ui.statusText.innerText = "å°±ç·’";
            ui.statusDot.classList.remove('active');
        }
    }

    function addMessage(text, type, side) {
        const div = document.createElement('div');
        div.className = 'message-group';
        const colorClass = side === 'A' ? 'border-color-A' : 'border-color-B';
        
        if (type === 'translated') {
            div.innerHTML = `<div class="translated-card ${colorClass}">${text}</div>`;
        } else {
            div.innerHTML = `<div class="original-text">${text}</div>`;
        }
        ui.chat.appendChild(div);
        ui.chat.scrollTop = ui.chat.scrollHeight;
    }
</script>
</body>
</html>
